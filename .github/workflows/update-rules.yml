name: Update AdGuard Rules (China Only)

on:
  schedule:
    - cron: "0 2 * * 1"  # 每周一凌晨 2 点
  workflow_dispatch:      # 支持手动触发

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true


      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install requests
        run: pip install requests

      - name: Fetch and merge China rules
        run: |
          python - <<EOF
          import requests

          urls = [
              "https://adaway.org/hosts.txt",
              "https://anti-ad.net/easylist.txt",
              "https://easylist-downloads.adblockplus.org/easyprivacy.txt",
              "https://easylist-downloads.adblockplus.org/easylistchina.txt",
              "https://easylist-downloads.adblockplus.org/easylistchina+easylist.txt",
              "https://raw.githubusercontent.com/cjx82630/cjxlist/master/cjx-annoyance.txt",
              "https://cdn.jsdelivr.net/gh/o0HalfLife0o/list@master/ad2.txt",
              "https://raw.githubusercontent.com/o0HalfLife0o/list/master/ad.txt",
              "https://raw.githubusercontent.com/BlueSkyXN/AdGuardHomeRules/master/all.txt",
              "https://gcore.jsdelivr.net/gh/217heidai/adblockfilters@main/rules/adblockdns.txt",
              "https://adguardteam.github.io/HostlistsRegistry/assets/filter_60.txt",
              "https://raw.githubusercontent.com/217heidai/adblockfilters/main/rules/adblockdns.txt",
              "https://raw.githubusercontent.com/AdguardTeam/FiltersRegistry/master/filters/filter_2_Base/filter.txt",
              "https://raw.githubusercontent.com/AdguardTeam/FiltersRegistry/master/filters/filter_224_Chinese/filter.txt",
              "https://raw.githubusercontent.com/AdguardTeam/AdguardFilters/master/MobileFilter/sections/adservers.txt",
              "https://adguardteam.github.io/AdGuardSDNSFilter/Filters/filter.txt",
              "https://raw.githubusercontent.com/Cats-Team/AdRules/main/dns.txt",
              "https://raw.githubusercontent.com/xinggsf/Adblock-Plus-Rule/master/mv.txt"
          ]

          seen = set()
          rules = []

          for url in urls:
              try:
                  r = requests.get(url, timeout=30)
                  r.raise_for_status()
                  for line in r.text.splitlines():
                      line = line.strip()
                      if not line or line.startswith("!") or line.startswith("#"):
                          continue
                      if line not in seen:
                          seen.add(line)
                          rules.append(line)
              except Exception as e:
                  print(f"Failed to fetch {url}: {e}")

          with open("adguard-rules.txt", "w", encoding="utf-8") as f:
              f.write("\n".join(rules))
          EOF

      - name: Commit and push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add adguard-rules.txt
          git commit -m "Update China-only AdGuard rules"
          git push
